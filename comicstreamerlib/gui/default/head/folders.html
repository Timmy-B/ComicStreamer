{% include base/head.html %}
<style type="text/css" title="currentStyle">
    @import "{{ static_url('dynatable/jquery.dynatable.css') }}";
    @import "{{ static_url('qtip2/jquery.qtip.css') }}";
    @import "{{ static_url('comicstreamer.css') }}";
</style>

<script type="text/javascript" src="{{ static_url('dynatable/jquery.dynatable.js') }}"></script>
<script src="{{ static_url('qtip2/jquery.qtip.js') }}"></script>

<script type="text/javascript" charset="utf-8">
    var webroot = '{{handler.webroot}}';
    var nokey_args = '{{args}}';
    args = nokey_args  + '?&api_key={{api_key}}'
    var url = '{{handler.webroot}}/folders' + args;
    var items = [];
    var root = "";
    function list_pusher( key, val)
    {
        browse_path = val.url_path.replace(new RegExp("^" + webroot + "/folders"), webroot + "/folders/browse");
        link_path = root + "/" + val.name; //val.current; //url_path //val.current + val.url_path.replace(new RegExp("^" + webroot + "/folders/"),"");
        //link_path =  link_path.split('/').slice(1).join("/")
        items.push( "<li><a href=\"" + browse_path + "?folder=" + link_path + "\">" + val.name+"</a></li>" );
    }

function processEntityList(data)
{
    if (data.current != "")
    {
        parent = nokey_args.split("/").slice(0,-1).join("/");
        str = data.current;
        root = str;
        //items.push( str + "ddd");
        args += ""
        
        $("#current").html("<a href=\"{{handler.webroot}}/folders/browse" + parent + "\"><img src=\"{{ static_url('icons/navigation/back.png') }}\"></a>"/*+str*/);
    }
    else
    {
        $("#current").html("<img src=\"{{ static_url('icons/navigation/home.png') }}\">");
    }
    
    $.each( data.folders, list_pusher);
    
    folder_div = document.getElementById("folders");
    $( "<ul/>", {
      "class": "my-new-list",
      html: items.join( "" )
      }).appendTo( folder_div );
      
      /*if ( data.current != "")
       {
       if (data.comics.count == 0)
       {
       $("#comics").text(""); //[No comics in this folder]
       }
       else
       {
       browse_path = data.comics.url_path.replace(new RegExp("^" + webroot + "/comiclist"), webroot + "/comiclist/browse");
       str = "<a href=\"" + browse_path + "\" class=\"browser_link\">Comics (" + data.comics.count.toString() +")</a>"
       $("#comics").html(str);
       }
       }*/
}
$.getJSON( encodeURI(url), processEntityList);




function populateComicDetails(cd, comic)
{
    
    var thumb_url = '{{handler.webroot}}/comic/'+ comic.id +'/thumbnail?api_key={{api_key}}';
    var reader_url = '{{handler.webroot}}/comic/'+ comic.id +'/reader?api_key={{api_key}}';
    var download_url = '{{handler.webroot}}/comic/'+ comic.id +'/file?api_key={{api_key}}';
    var json_url = '{{handler.webroot}}/comic/'+ comic.id +'?api_key={{api_key}}';
    
    $(cd).find('.cd_thumbnail').attr('src', thumb_url);
    $(cd).find(".cd_reader_link").attr('href', reader_url);
    
    //$(cd).find(".cd_file_link").text(comic.path);
    $(cd).find(".cd_path").text(comic.path);
    
    $(cd).find(".cd_file_link").attr('href', download_url);
    $(cd).find(".cd_json_link").attr('href', json_url);
    
    str = comic.series;
    if (comic.issue !== "") {
        str = str + ' #' + comic.issue;
    }
    $(cd).find(".cd_issue").text(str);
    
    if (comic.year !== "") {
        str = comic.year.toString();
        if (comic.month !== "") {
            month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            str = month_names[comic.month-1] + " " + str;
        }
        
        str = '(' + str + ')'
        $(cd).find(".cd_date").text(str);
    }
    
    if (comic.title !== "") {
        str = '"' + comic.title + '"';
        $(cd).find(".cd_title").text(str);
    }
    if (comic.language !== "") {
        str = '"' + comic.language + '"';
        
        $(cd).find(".cd_language").text(str);
    }
    
    if (comic.volume !== "") {
        str = "vol. " + comic.volume.toString() + ", ";
        $(cd).find(".cd_volume").text(str);
    }
    
    $(cd).find(".cd_publisher").text(comic.publisher);
    $(cd).find(".cd_pagecount").text("[" + comic.page_count + " pages]") ;
    
    comments = comic.comments
    if (comments != null && comments.length > 500)
    {
        comments = comments.substring(0,500) + "..."
    }
    
    $(cd).find(".cd_comments").text(comments);
    
    for (var property in comic.credits) {
        $(cd).find('.cd_credits').append('<tr><td>' + property + '</td><td>' + comic.credits[property].join(", ") + '</td></tr>');
    }
    
    if (comic.hasOwnProperty("characters") && comic.characters.length != 0) {
        $(cd).find('.cd_lists').append('<tr><td>Characters</td><td>' + comic.characters.join(", ") + '</td></tr>');
    }
    if (comic.hasOwnProperty("teams") && comic.teams.length != 0) {
        $(cd).find('.cd_lists').append('<tr><td>Teams</td><td>' + comic.teams.join(", ") + '</td></tr>');
    }
    if (comic.hasOwnProperty("locations") && comic.locations.length != 0) {
        $(cd).find('.cd_lists').append('<tr><td>Locations</td><td>' + comic.locations.join(", ") + '</td></tr>');
    }
    if (comic.hasOwnProperty("storyarcs") && comic.storyarcs.length != 0) {
        $(cd).find('.cd_lists').append('<tr><td>Story Arcs</td><td>' + comic.storyarcs.join(", ") + '</td></tr>');
    }
    if (comic.hasOwnProperty("tags") && comic.tags.length != 0) {
        $(cd).find('.cd_lists').append('<tr><td>Tags</td><td>' + comic.tags.join(", ") + '</td></tr>');
    }
    return cd;
}

function myAttributeWriter(record)
{
    var val = record[this.id];
    if (this.id == 'thumb_url')
    {
        
        val = '<img src="{{handler.webroot}}/comic/'+ record.id +'/thumbnail/small?api_key={{api_key}}" width=50/>';
    }
    if (this.id == 'datex')
    {
        if (record['day'] != "" && record['month'] != "" && record['year'] != "")
        {
            val = record['day'] + '/' + record['month'] + '/' + record['year'];
        } else if (record['month'] != "" && record['year'] != "")
        {
            val = record['month'] + '/' + record['year'];
        }
        else if (record['year'] != "")
        {
            val = record['year'];
        }
        else
        {
            val = "";
        }
    }
    
    return val;
}
function myRowWriter(rowIndex, record, columns, cellWriter)
{
    var tr = '';
    
    // grab the record's attribute for each column
    for (var i = 0, len = columns.length; i < len; i++)
    {
        tr += cellWriter(columns[i], record);
    }
    
    // add a special id with the comic ID for lookup later on
    rowstr =  '<tr id="comic'+ record.id +'">' + tr + '</tr>';
    
    //debugger;
    return rowstr;
}

function addToolTips(rows)
{
    
    var dynatable = $("#resultset").data("dynatable")
    var comics = dynatable.settings.dataset.records
    
    for(var i=0, len=comics.length; i < len; i++)
    {
        comic = comics[i];
        row = $('#comic'+comic.id)
        
        // setup tooltip HTML
        
        // Find the hidden comic details template and clone it
        cd = $('#cd_template').clone();
        // Populate it from the comic record
        cd = populateComicDetails(cd, comic);
        //grab the html text
        popup_text = $(cd).html()
        
        row.qtip( {
                 show: 'click',
                 hide:
                 {
                 event: 'unfocus',
                 },
                 content: {
                 text: popup_text,
                 button: 'Close'
                 },
                 position: {
                 target: $(window),
                 //target: 'mouse',
                 //my: 'left center',
                 my: 'center',
                 at: 'center',
                 viewport: $(window),
                 adjust: {
                 screen: true,
                 mouse: false,
                 }
                 },
                 style: {
                 classes: 'qtip-blue qtip-shadow',
                 width: 800,
                 //def: false
                 }
                 });
                 
    }
}


function setupTable()
{
    if (location.search.length > 0)
    {
        args = location.search  + '&api_key={{api_key}}';
    }
    else
    {
        args = location.search  + '?api_key={{api_key}}';
    }
    var table_init =
    {
        features:
        {
            paginate: true,
            search: true
        },
        dataset:
        {
            ajax: true,
            ajaxUrl: '{{src}}'+ args,
            ajaxOnLoad: true,
            records: [],
            //ajaxCache: null,
            //ajaxMethod: 'GET',
            perPageDefault: 10,
            perPageOptions: [10,20,50,100,200],
            
        },
        params:
        {
            //queries: 'queries',
            //sorts: 'order',
            perPage: 'per_page',
            records: 'comics',
            queryRecordCount: 'total_count',
            totalRecordCount: 'page_count'
        },
        writers:
        {
            _rowWriter: myRowWriter,
            _attributeWriter: myAttributeWriter
        },
    }
    
    $('#resultset').dynatable( table_init);
    $('#resultset').bind('dynatable:afterUpdate', addToolTips);
    
}

$(document).ready(
                  function()
                  {
                  setupTable();
                  }
                  );
</script>
    </head>
    <body>
{% include menu/browser.html %}
        <div id=content>